import pandas

def import_idi_vuln(env, target, source):

    def clean_name(s):
        return s.replace(' ','_').replace('-','_')

    with open(str(source[0]), 'r') as fd:
        fd.readline()
        fd.readline()
        csvfile = csv.DictReader(fd)

        deltas = pandas.read_pickle(str(source[1]))

        vuln = pandas.Series(index=deltas.index)
        for rec in csvfile:
            vuln[clean_name(rec['Delta'])] = float(rec['InvestmentDeficitIndex'])

    vuln.to_pickle(str(target[0]))
    return 0


def compute_unity_norm_econ_vuln(env, source, target):
    '''
    Normalize to 0-1 range
    '''
    gdp = pandas.read_pickle(str(source[0]))
    percap = pandas.read_pickle(str(source[1]))

    # normalize to min/max across all deltas, all SSPs, all years
    def norm(x):
        return (x - x.min().min()) / x.max().max()

    econ_capacity = norm(norm(gdp) + norm(percap))
    econ_vuln = 1 - econ_capacity
    econ_vuln.to_pickle(str(target[0]))
    return 0


def extract_energy_cost_index_from_eia_outlook(env, source, target):
    data = pandas.read_csv(str(source[0]), header=4) # some manual edits made to csv to fix string quoting
    key = env['key']
    to_year = 2100

    data = data.set_index('api key')
    data = data.drop(['Unnamed: 0', 'full name', 'units'], axis=1)
    energy_index = data.loc[key]

    # growth rate is computed by EIA, but starting at 2016 rather than 2015. do manually
    # growth_rate = float(energy_index.iloc[-1].replace('%',''))/100.
    energy_index = energy_index.iloc[:-1]
    energy_index.index = [int(i) for i in energy_index.index]
    y1, y2 = energy_index.index[[0, -1]]
    growth_rate = (energy_index[y2]/energy_index[y1]) ** (1./(y2-y1)) - 1

    # extrapolate out based on 2015-2050 growth rate
    for year in range(energy_index.index[-1]+1, to_year+1):
        energy_index[year] = energy_index[year-1] * (1 + growth_rate)

    energy_index.to_pickle(str(target[0]))
    return 0


def adj_gdp_for_energy_prices(env, source, target):
    '''
    Discount GDP based on energy cost index growth from baseline (2016)
    '''
    gdp = pandas.read_pickle(str(source[0]))
    percap = pandas.read_pickle(str(source[1]))
    energy_index = pandas.read_pickle(str(source[2]))

    gdp_adj = pandas.DataFrame(index=gdp.index, columns=gdp.columns)
    percap_adj = pandas.DataFrame(index=percap.index, columns=percap.columns)
    for (ssp, year), gdps in gdp.iteritems():
        gdp_adj.loc[:, (ssp, year)] = gdps / (energy_index.get(year, energy_index.iloc[0]) / energy_index.iloc[0])
    for (ssp, year), percaps in percap.iteritems():
        percap_adj.loc[:, (ssp, year)] = percaps / (energy_index.get(year, energy_index.iloc[0]) / energy_index.iloc[0])

    gdp_adj.to_pickle(str(target[0]))
    percap_adj.to_pickle(str(target[1]))
    return 0

