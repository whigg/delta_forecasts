# vim: set fileencoding=UTF-8 :
# vim:filetype=python

import os
import process_risk as pr
from itertools import combinations

Import('*')

for experiment, config in experiments.iteritems():

    if config['vuln_source'][0] == 'tessler2015':
        env.Command(
                source=[config['vuln_source'][1],
                        config['delta_zeros']],
                target=config['vuln'],
                action=pr.import_idi_vuln)

    env.Command(
            source=[config['surge_annual_exposure'],
                    config['vuln']],
            target=config['surge_risk'],
            action=pr.adj_annual_exposure_for_vuln)

    env.Command(
            source=[config['surge_risk'],
                    config['pop_hypso_growth']],
            target=config['surge_percap_risk'],
            action=pr.per_capita_exposure)

    for delta in common['deltas']:
        env.Command(
                source=config['surge_annual_exposure'],
                target=config['surge_annual_exposure_plot'].format(delta=delta, ext='png'),
                action=pr.plot_surge_annual_exposure,
                delta=delta,
                exp=config['name'])

scenarios, configs = zip(*list(experiments.iteritems()))
env.Command(
        source=[c['surge_annual_exposure'] for c in configs],
        target=config['surge_annual_exposure_ranges'],
        action=pr.compute_exposure_ranges)

# for (expA, expB) in combinations(experiments.keys(), 2):
for expA in experiments.keys():
    for expB in experiments[expA]['compare_with']:
        scenarios = expA + '_' + expB
        env.Command(
                source=[experiments[expA]['surge_annual_exposure'],
                        experiments[expB]['surge_annual_exposure'],
                        config['surge_annual_exposure_ranges']],
                target=config['surge_annual_exposure_comparison_multidelta_plot'].format(scenarios=scenarios, ext='png'),
                action=pr.plot_surge_annual_exposure_multiscenario_multidelta,
                scenarios=[experiments[expA]['name'], experiments[expB]['name']])
        for delta in common['deltas']:
            env.Command(
                    source=[experiments[expA]['surge_annual_exposure'],
                            experiments[expB]['surge_annual_exposure']],
                    target=config['surge_annual_exposure_comparison_plot'].format(delta=delta, scenarios=scenarios, ext='png'),
                    action=pr.plot_surge_annual_exposure_multiscenario,
                    delta=delta,
                    scenarios=[experiments[expA]['name'], experiments[expB]['name']])
